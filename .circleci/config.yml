version: 2.1

defaults: &defaults
  machine: true
  working_directory: ~/repo

update_docker: &update_docker
  name: 'Update Docker'
  command: |
    docker --version
    sudo apt-get update
    sudo apt-get install docker-ce
    docker --version

update_docker_compose: &update_docker_compose
  name: 'Update Docker Compose'
  command: |
    docker-compose --version    
    sudo curl -L https://github.com/docker/compose/releases/download/1.23.2/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
    docker-compose --version

jobs:
  build_test_deploy:
    <<: *defaults
    steps:
      - checkout

      - run:
          <<: *update_docker
      - run:
          <<: *update_docker_compose

      - run:
          name: Build Docker Images (Test Env)
          command: |
            env > ./docker/test/.env
            npm run dc:test build api

      - run:
          name: Build Docker Images (Release Env)
          command: |
            env > ./docker/release/.env
            npm run dc:rel build api

      - run:
          name: Run Unit Tests
          command: npm run dc:test:run-test

      - run:
          name: Install Heroku
          command: curl https://cli-assets.heroku.com/install.sh | sh

      - run:
          name: 'Deploy API to Heroku'
          command: |
            docker login --username=_ --password=$HEROKU_TOKEN registry.heroku.com 
            docker tag wtrips-api:release registry.heroku.com/wtrips-demo/web
            docker push registry.heroku.com/wtrips-demo/web
            heroku container:release web

tag_filter: &tag_filter
  branches:
    # ignore any commit on any branch by default
    ignore: /.*/
  tags:
    # only act on version tags
    only: /^v[0-9]+(\.[0-9]+)*(-\w+\.[0-9]+)?$/

workflows:
  version: 2
  build_test_deploy:
    jobs:
      - build_test_deploy:
          filters:
            branches:
              only: heroku
